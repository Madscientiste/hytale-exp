name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  HYTALE_SERVER_VERSION: "2026.01.15-c04fdfe10"

permissions:
  contents: read
  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'gradle'

      - name: Cache server files
        uses: actions/cache@v4
        with:
          path: libs/
          key: server-files-${{ runner.os }}-${{ env.HYTALE_SERVER_VERSION }}
          restore-keys: |
            server-files-${{ runner.os }}-

      - name: Check if server files exist
        id: check-server-files
        run: |
          if [ -f libs/HytaleServer.jar ] && [ -f libs/Assets.zip ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        if: steps.check-server-files.outputs.exists != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract server files
        if: steps.check-server-files.outputs.exists != 'true'
        run: |
          mkdir -p server-files
          # For scratch-based images, export as tar and extract files from layers
          docker image save ghcr.io/madscientiste/hytale-server:${{ env.HYTALE_SERVER_VERSION }} -o /tmp/hytale-image.tar
          # Extract manifest and find the layer with server files
          EXTRACT_DIR=$(mktemp -d)
          tar -xf /tmp/hytale-image.tar -C "$EXTRACT_DIR"
          # Find layer containing server/ directory
          for layer_tar in "$EXTRACT_DIR"/*/layer.tar; do
            if [ -f "$layer_tar" ] && tar -tf "$layer_tar" 2>/dev/null | grep -q "^server/"; then
              tar -xf "$layer_tar" server/ -C server-files --strip-components=1
              break
            fi
          done
          rm -rf /tmp/hytale-image.tar "$EXTRACT_DIR"

      - name: Set up server files
        if: steps.check-server-files.outputs.exists != 'true'
        run: |
          mkdir -p libs
          
          # Find and rename hs-*.jar to HytaleServer.jar
          HS_JAR=$(find ./server-files -name "hs-*.jar" | head -1)
          if [ -n "$HS_JAR" ]; then
            cp "$HS_JAR" ./libs/HytaleServer.jar
            echo "Copied $(basename "$HS_JAR") to libs/HytaleServer.jar"
            
            # Extract version from filename for verification
            VERSION=$(basename "$HS_JAR" | sed 's/^hs-\(.*\)\.jar$/\1/')
            echo "Server version: $VERSION"
            echo "Expected version: ${{ env.HYTALE_SERVER_VERSION }}"
          else
            echo "Warning: hs-*.jar not found in server-files"
            ls -la ./server-files
          fi
          
          # Find and rename ha-*.zip to Assets.zip
          HA_ZIP=$(find ./server-files -name "ha-*.zip" | head -1)
          if [ -n "$HA_ZIP" ]; then
            cp "$HA_ZIP" ./libs/Assets.zip
            echo "Copied $(basename "$HA_ZIP") to libs/Assets.zip"
            
            # Extract version from filename for verification
            VERSION=$(basename "$HA_ZIP" | sed 's/^ha-\(.*\)\.zip$/\1/')
            echo "Assets version: $VERSION"
          else
            echo "Warning: ha-*.zip not found in server-files"
            ls -la ./server-files
          fi

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**/*

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/build/libs/*.jar
          retention-days: 7

  dependency-submission:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'gradle'

      - name: Cache server files
        uses: actions/cache@v4
        with:
          path: libs/
          key: server-files-${{ runner.os }}-${{ env.HYTALE_SERVER_VERSION }}
          restore-keys: |
            server-files-${{ runner.os }}-

      - name: Generate and submit dependency graph
        uses: gradle/actions/dependency-submission@v4
