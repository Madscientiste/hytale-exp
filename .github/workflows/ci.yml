name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  HYTALE_SERVER_VERSION: "2026.01.15-c04fdfe10"

permissions:
  contents: read
  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'gradle'

      - name: Cache server files
        uses: actions/cache@v4
        with:
          path: libs/
          key: server-files-${{ runner.os }}-${{ env.HYTALE_SERVER_VERSION }}
          restore-keys: |
            server-files-${{ runner.os }}-

      - name: Check if server files exist
        id: check-server-files
        run: |
          if [ -f libs/HytaleServer.jar ] && [ -f libs/Assets.zip ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        if: steps.check-server-files.outputs.exists != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract server files
        if: steps.check-server-files.outputs.exists != 'true'
        run: |
          mkdir -p libs server-files
          docker create --name hytale-server-extract \
            ghcr.io/madscientiste/hytale-server:${{ env.HYTALE_SERVER_VERSION }}
          docker cp hytale-server-extract:/server ./server-files
          docker rm hytale-server-extract
          
          # Find and copy files with proper names
          HS_JAR=$(find ./server-files -name "hs-*.jar" | head -1)
          HA_ZIP=$(find ./server-files -name "ha-*.zip" | head -1)
          
          if [ -n "$HS_JAR" ]; then
            cp "$HS_JAR" ./libs/HytaleServer.jar
            echo "Copied $(basename "$HS_JAR") to HytaleServer.jar"
          else
            echo "Error: hs-*.jar not found in server-files"
            ls -la ./server-files
            exit 1
          fi
          
          if [ -n "$HA_ZIP" ]; then
            cp "$HA_ZIP" ./libs/Assets.zip
            echo "Copied $(basename "$HA_ZIP") to Assets.zip"
          else
            echo "Error: ha-*.zip not found in server-files"
            ls -la ./server-files
            exit 1
          fi
          
          echo "Extracted server files:"
          ls -la ./libs/

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**/*

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/build/libs/*.jar
          retention-days: 7

  dependency-submission:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'gradle'

      - name: Cache server files
        uses: actions/cache@v4
        with:
          path: libs/
          key: server-files-${{ runner.os }}-${{ env.HYTALE_SERVER_VERSION }}
          restore-keys: |
            server-files-${{ runner.os }}-

      - name: Generate and submit dependency graph
        uses: gradle/actions/dependency-submission@v4
